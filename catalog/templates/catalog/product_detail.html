{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<style>
  #pd-carousel {
    height: auto !important;
    min-height: 0 !important;
  }
</style>

<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <div id="pd-carousel" class="relative overflow-hidden select-none w-full max-w-full mx-auto">
    <div class="pd-track flex transition-transform duration-300 ease-out">
      {% if product.image %}
        <div class="pd-slide">
          <div class="ar-3-4">
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="fill pointer-events-none" loading="eager">
          </div>
        </div>
      {% endif %}
      {% for gi in product.images.all %}
        {% if not product.image or gi.image.url != product.image.url %}
          <div class="pd-slide">
            <div class="ar-3-4">
              <img src="{{ gi.image.url }}" alt="{{ gi.alt_text|default:product.name }}" class="fill pointer-events-none" loading="lazy">
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <button type="button" class="hidden md:grid absolute left-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-white/90 hover:bg-white shadow place-items-center pd-prev" aria-label="Previous image">
      <svg viewBox="0 0 24 24" class="w-5 h-5"><path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <button type="button" class="hidden md:grid absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-white/90 hover:bg-white shadow place-items-center pd-next" aria-label="Next image">
      <svg viewBox="0 0 24 24" class="w-5 h-5"><path d="M9 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>

    <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex justify-center gap=1.5">
      {% if product.image %}
        <button type="button" class="pd-dot w-2 h-2 rounded-full bg-white/90"></button>
      {% endif %}
      {% for gi in product.images.all %}
        {% if not product.image or gi.image.url != product.image.url %}
          <button type="button" class="pd-dot w-2 h-2 rounded-full bg-white/60"></button>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  {% if product.image or product.images.all %}
    <div class="mt-3 hidden md:flex gap-2 overflow-x-auto">
      {% if product.image %}
        <button type="button" class="pd-thumb w-20 overflow-hidden border rounded" data-index="0">
          <div class="ar-3-4"><img src="{{ product.image.url }}" class="fill" alt=""></div>
        </button>
      {% endif %}
      {% for gi in product.images.all %}
        {% if not product.image or gi.image.url != product.image.url %}
          <button type="button"
                  class="pd-thumb w-20 overflow-hidden border rounded"
                  data-index="{% if product.image %}{{ forloop.counter }}{% else %}{{ forloop.counter0 }}{% endif %}">
            <div class="ar-3-4"><img src="{{ gi.image.url }}" class="fill" alt="{{ gi.alt_text }}"></div>
          </button>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  <h1 class="text-[22px] font-bold text-gray-900 leading-snug mt-4">{{ product.name }}</h1>
  <p class="text-gray-500 text-sm mt-1">SKU: {{ product.sku }}</p>
  <a href="#" class="text-blue-600 font-medium hover:underline mt-1 inline-block">
    {{ product.owner.name }}
  </a>
  <p class="text-gray-700 text-sm mt-1">
    Price: ₹{{ product.wholesale_price }} per unit
  </p>

  <div class="border-t mt-4 mb-3"></div>

  <div class="mb-4">
    <h3 class="text-sm font-semibold text-gray-900 mb-2">Available Sizes</h3>
    <div class="flex gap-2 flex-wrap">
      {% for size, qty in product.size_stock_display.items %}
        <span class="px-3 py-1 rounded-full border text-sm text-gray-800 bg-white">
          {{ size }}
        </span>
      {% empty %}
        <span class="text-sm text-gray-400">No sizes listed</span>
      {% endfor %}
    </div>
  </div>

  <div class="border-t mt-4 mb-3"></div>

  <div class="mb-4">
    <h3 class="text-sm font-semibold text-gray-900 mb-3">Select a Pack</h3>
    
    {% with moqs=product.available_moq_options %}
      {% if moqs %}
        <div id="moq-group" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          {% for option in moqs %}
            <button
              type="button"
              class="moq-btn flex items-center justify-center gap-2 rounded-2xl border px-4 py-2 bg-white text-gray-900 hover:bg-gray-50"
              data-index="{{ forloop.counter0 }}"
              data-pcs="{{ option.total_quantity }}"
              data-ratio="{{ option.display_label }}"
              aria-pressed="false"
            >
              <span class="font-semibold">{{ option.total_quantity }} pcs</span>
              <span class="opacity-60">|</span>
              <span class="truncate">{{ option.sizes_str }} | {{ option.ratio_str }}</span>
            </button>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-sm text-gray-400">There are no available packs for this product right now.</p>
      {% endif %}
    {% endwith %}
  </div>

  <div class="border-t mt-4 mb-3"></div>

  {% with moqs=product.available_moq_options %}
    {% if moqs %}
      {% with minpcs=moqs.0.total_quantity %}
        <div class="mb-4">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold text-gray-900">Quantity</h3>
            <!-- <span class="text-sm text-gray-500">Min: {{ minpcs }} pcs</span> -->
          </div>
          <div class="mt-2 flex items-center gap-3">
            <button type="button" id="qty-minus" class="h-9 w-9 grid place-items-center rounded-lg border bg-white text-gray-800">−</button>
            <input id="qty-input" type="number" min="{{ minpcs }}" step="{{ minpcs }}" value="{{ minpcs }}" class="w-14 text-center h-9 rounded-lg border bg-white" />
            <button type="button" id="qty-plus" class="h-9 w-9 grid place-items-center rounded-lg border bg-white text-gray-800">+</button>
          </div>
        </div>
      {% endwith %}
    {% else %}
      <div class="mb-4">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold text-gray-900">Quantity</h3>
          <span class="text-sm text-gray-500">Min: 1 pcs</span>
        </div>
        <div class="mt-2 flex items-center gap-3">
          <button type="button" id="qty-minus" class="h-9 w-9 grid place-items-center rounded-lg border bg-white text-gray-800">−</button>
          <input id="qty-input" type="number" min="1" step="1" value="1" class="w-14 text-center h-9 rounded-lg border bg-white" />
          <button type="button" id="qty-plus" class="h-9 w-9 grid place-items-center rounded-lg border bg-white text-gray-800">+</button>
        </div>
      </div>
    {% endif %}
  {% endwith %}

  <div class="rounded-2xl border bg-blue-50/60 p-4 mb-4">
    <div class="flex items-center justify-between">
      <span class="text-sm text-gray-700">Total Price:</span>
      <span id="total-amount" class="text-xl font-bold text-blue-700">₹{{ product.wholesale_price }}</span>
    </div>
    <div class="text-xs text-gray-500 mt-1">
      ₹<span id="unit-price">{{ product.wholesale_price }}</span> × <span id="qty-label">1</span> pieces
    </div>
  </div>

  <div class="space-y-3 mb-8">
    {% if user.is_authenticated and user.organization.org_type == "retailer" %}
      <button id="btn-add-to-cart"
        class="w-full h-12 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
        disabled>
        <span class="text-lg">+</span>
        <span id="add-to-cart-text">Add To Cart</span>
      </button>
      <p id="moq-message" class="text-center text-sm text-red-600 hidden">Please select a pack to continue.</p>

    {% elif user.is_authenticated and user.organization.org_type == "wholesaler" %}
      <button disabled class="w-full h-12 rounded-xl bg-gray-400 text-white font-semibold flex items-center justify-center gap-2 cursor-not-allowed">
        <span class="text-lg">+</span>
        <span>Retailers Only</span>
      </button>

    {% else %}
      <a href="{% url 'accounts:login' %}?next={{ request.path }}"
        class="w-full h-12 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold flex items-center justify-center gap-2">
        <span>Login to Add to cart</span>
      </a>
    {% endif %}

    <a href="https://wa.me/{{ product.owner.phone|default:'+919778192886' }}?text=Hi,%20I'm%20interested%20in%20{{ product.name }}"
       class="w-full h-12 rounded-xl bg-green-600 hover:bg-green-700 text-white font-semibold flex items-center justify-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.004 2C6.478 2 2 6.478 2 12.004c0 2.119.61 4.107 1.667 5.785L2 22l4.354-1.626A9.95 9.95 0 0 0 12.004 22C17.53 22 22 17.522 22 12.004 22 6.478 17.53 2 12.004 2Zm0 18c-1.756 0-3.39-.516-4.763-1.404l-.341-.213-2.584.964.919-2.674-.222-.342A7.96 7.96 0 0 1 4 12.004C4 7.59 7.59 4 12.004 4c4.413 0 8.003 3.59 8.003 8.004 0 4.415-3.59 8.004-8.003 8.004Z"/></svg>
      <span>Inquire via WhatsApp</span>
    </a>
  </div>

  <section class="mt-8 border-t pt-6">
    <h3 class="text-sm font-semibold text-gray-900 mb-3">Product Details</h3>

    {% if product.description %}
      <p class="text-sm text-gray-700 leading-relaxed">{{ product.description }}</p>
    {% else %}
      <p class="text-sm text-gray-400">No description provided.</p>
    {% endif %}

    <div class="mt-4 grid grid-cols-2 gap-6">
  <div>
    <h4 class="text-xs font-medium text-gray-500">Fabric</h4>
    <p class="text-sm text-gray-800">
      {% for fabric in product.fabrics.all %}
        {{ fabric.name }}{% if not forloop.last %}, {% endif %}
      {% empty %}
        —
      {% endfor %}
    </p>
  </div>

  <div>
    <h4 class="text-xs font-medium text-gray-500">Colors</h4>
    <p class="text-sm text-gray-800">
      {% for c in product.colors.all %}
        {{ c.name }}{% if not forloop.last %}, {% endif %}
      {% empty %}
        —
      {% endfor %}
    </p>
  </div>

      <div class="col-span-2">
        <div class="rounded-xl border bg-white p-4 flex items-center justify-between">
          <span class="text-sm text-gray-600">Suggested Retail Price</span>
          <span class="text-base font-bold text-gray-900">
            {% if product.retail_price %}
              ₹{{ product.retail_price }}
            {% elif product.mrp %}
              ₹{{ product.mrp }}
            {% else %}
              —
            {% endif %}
            <span class="text-xs font-normal text-gray-500">per unit</span>
          </span>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  const price = Number(document.getElementById('unit-price').textContent.replace(/[^0-9.]/g,'')) || 0;
  const qtyInput = document.getElementById('qty-input');
  const qtyMinus = document.getElementById('qty-minus');
  const qtyPlus  = document.getElementById('qty-plus');
  const totalEl  = document.getElementById('total-amount');
  const qtyLabel = document.getElementById('qty-label');

  function step() { return Number(qtyInput.step || 1) || 1; }
  function minQty() { return Number(qtyInput.min || 1) || 1; }
  function clampToStep(val){ const s=step(), m=minQty(); return Math.max(m, Math.round(val/s)*s); }

  function render(){
    const qty = Number(qtyInput.value) || minQty();
    const clamped = clampToStep(qty);
    if (clamped !== qty) qtyInput.value = clamped;
    totalEl.textContent = '₹' + (clamped * price).toLocaleString('en-IN');
    qtyLabel.textContent = String(clamped);
  }

  qtyMinus && qtyMinus.addEventListener('click', () => { qtyInput.value = Math.max(minQty(), (Number(qtyInput.value)||minQty()) - step()); render(); });
  qtyPlus  && qtyPlus.addEventListener('click',  () => { qtyInput.value = (Number(qtyInput.value)||minQty()) + step(); render(); });
  qtyInput.addEventListener('input', render);
  render();
})();
</script>

<script>
(function () {
  const moqGroup = document.getElementById('moq-group');
  if (!moqGroup) return;
  const btns = Array.from(moqGroup.querySelectorAll('.moq-btn'));
  const qtyInput = document.getElementById('qty-input');
  const unitPrice = Number((document.getElementById('unit-price')?.textContent||'').replace(/[^0-9.]/g,'')) || 0;
  const totalEl  = document.getElementById('total-amount');
  const qtyLabel = document.getElementById('qty-label');
  const addBtn = document.getElementById('btn-add-to-cart');
  const moqMessage = document.getElementById('moq-message');

  function setActive(i) {
    btns.forEach((b, bi) => {
      const active = bi === i;
      b.setAttribute('aria-pressed', active ? 'true' : 'false');
      b.classList.toggle('bg-black', active);
      b.classList.toggle('text-white', active);
      b.classList.toggle('border-black', active);
      b.classList.toggle('hover:bg-gray-50', !active);
    });
    const pcs = Number(btns[i].dataset.pcs) || 1;
    if (qtyInput) {
      qtyInput.min = String(pcs);
      qtyInput.step = String(pcs);
      let val = Number(qtyInput.value) || pcs;
      val = Math.max(pcs, Math.round(val / pcs) * pcs);
      qtyInput.value = String(val);
      totalEl.textContent = '₹' + (val * unitPrice).toLocaleString('en-IN');
      qtyLabel.textContent = String(val);
    }
    
    if (addBtn) {
        addBtn.disabled = false;
    }
    if (moqMessage) {
        moqMessage.classList.add('hidden');
    }
  }

  btns.forEach((btn, i) => btn.addEventListener('click', () => setActive(i)));
})();
</script>

<script>
(function(){
  function csrftoken(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }
  const addBtn = document.getElementById('btn-add-to-cart');
  const qtyInput = document.getElementById('qty-input');
  const unitEl = document.getElementById('unit-price');
  const moqMessage = document.getElementById('moq-message');
  const moqActive = () => document.querySelector('#moq-group .moq-btn[aria-pressed="true"]');
  if (!addBtn) return;

  addBtn.addEventListener('click', async () => {
    const moqBtn = moqActive();
    // If no pack is selected, show the message and stop.
    if (!moqBtn) {
      if (moqMessage) {
        moqMessage.classList.remove('hidden');
      }
      return; 
    }

    const productId = "{{ product.id }}";
    const quantity  = qtyInput ? (Number(qtyInput.value)||1) : 1;
    const price     = unitEl ? unitEl.textContent.replace(/[^0-9.]/g,'') : "{{ product.wholesale_price }}";
    const moqLabel  = moqBtn.dataset.ratio || '';

    const form = new URLSearchParams();
    form.set('product_id', productId);
    form.set('quantity', String(quantity));
    form.set('price', String(price));
    if (moqLabel) form.set('moq_label', moqLabel);
    {% if product.image %} form.set('image_url', "{{ product.image.url }}"); {% endif %}

    const res = await fetch("{% url 'orders:add_to_cart' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken(), "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: form.toString(),
    });

    if (!res.ok) { 
      alert("Could not add to cart."); 
      return; 
    }
    window.location.href = "{% url 'orders:view_cart' %}";
  });
})();
</script>

<script>
(function () {
  const root = document.getElementById('pd-carousel');
  if (!root) return;

  const track  = root.querySelector('.pd-track');
  const slides = Array.from(root.querySelectorAll('.pd-slide'));
  const prev   = root.querySelector('.pd-prev');
  const next   = root.querySelector('.pd-next');
  const dots   = Array.from(root.querySelectorAll('.pd-dot'));
  const thumbs = Array.from(document.querySelectorAll('.pd-thumb'));

  let index = 0, slideW = 0;

  function layout() {
    slideW = Math.round(root.getBoundingClientRect().width);
    slides.forEach(s => { s.style.width = slideW + 'px'; });
    goTo(index, false);
  }

  function goTo(i, animate = true) {
    index = Math.max(0, Math.min(i, slides.length - 1));
    if (!animate) track.style.transition = 'none';
    track.style.transform = `translateX(${-index * slideW}px)`;
    if (!animate) { void track.offsetWidth; track.style.transition = ''; }

    dots.forEach((d, di) => { d.style.backgroundColor = (di === index) ? 'white' : 'rgba(255,255,255,0.6)'; });
    thumbs.forEach((t, ti) => {
      t.classList.toggle('ring-2', ti === index);
      t.classList.toggle('ring-blue-500', ti === index);
    });
  }

  // arrows
  prev && prev.addEventListener('click', () => goTo(index - 1));
  next && next.addEventListener('click', () => goTo(index + 1));

  // dots
  dots.forEach((d, di) => d.addEventListener('click', () => goTo(di)));

  // thumbs
  thumbs.forEach(t => t.addEventListener('click', () => {
    const i = Number(t.getAttribute('data-index'));
    if (!Number.isNaN(i)) goTo(i);
  }));

  // drag/swipe with vertical/horizontal detection
  let startX = 0, startY = 0;
  let curX = 0, curY = 0;
  let dragging = false;
  let horizontalGesture = undefined; // undefined until we know direction
  const DIRECTION_THRESHOLD = 8; // px before deciding direction
  const SWIPE_THRESHOLD = () => Math.max(40, slideW * 0.15);

  function onStart(x, y) {
    dragging = true;
    startX = curX = x;
    startY = curY = y;
    horizontalGesture = undefined;
    track.style.transition = 'none';
  }

  function onMove(x, y, evt) {
    if (!dragging) return;
    curX = x;
    curY = y;
    const dx = curX - startX;
    const dy = curY - startY;

    // Decide gesture direction once movement exceeds threshold
    if (horizontalGesture === undefined) {
      if (Math.abs(dx) < DIRECTION_THRESHOLD && Math.abs(dy) < DIRECTION_THRESHOLD) {
        // not enough movement yet
        return;
      }
      horizontalGesture = Math.abs(dx) > Math.abs(dy);
    }

    if (horizontalGesture) {
      // Horizontal swipe: prevent page scroll and move carousel
      if (evt && typeof evt.preventDefault === 'function') evt.preventDefault();
      track.style.transform = `translateX(${(-index * slideW) + dx}px)`;
    } else {
      // Vertical gesture: let browser handle scrolling — stop handling drag
      // We end dragging here so we don't keep intercepting touchmove.
      dragging = false;
      track.style.transition = '';
      goTo(index); // snap back to current slide position (if partially moved)
    }
  }

  function onEnd() {
    if (!dragging) return;
    dragging = false;
    track.style.transition = '';
    const d = curX - startX;
    if (horizontalGesture) {
      if (d > SWIPE_THRESHOLD()) goTo(index - 1);
      else if (d < -SWIPE_THRESHOLD()) goTo(index + 1);
      else goTo(index);
    } else {
      // vertical -> do nothing special
      goTo(index);
    }
  }

  // mouse (desktop)
  track.addEventListener('mousedown', (e) => { e.preventDefault(); onStart(e.clientX, e.clientY); });
  window.addEventListener('mousemove', (e) => onMove(e.clientX, e.clientY, e));
  window.addEventListener('mouseup', onEnd);

  // touch (mobile)
  track.addEventListener('touchstart', (e) => {
    if (!e.touches || !e.touches[0]) return;
    onStart(e.touches[0].clientX, e.touches[0].clientY);
  }, { passive: true });

  track.addEventListener('touchmove', (e) => {
    if (!e.touches || !e.touches[0]) return;
    onMove(e.touches[0].clientX, e.touches[0].clientY, e);
  }, { passive: false });

  track.addEventListener('touchend', onEnd, { passive: true });
  track.addEventListener('touchcancel', onEnd, { passive: true });

  window.addEventListener('resize', layout);
  requestAnimationFrame(layout);
  window.addEventListener('load', layout);
})();
</script>

{% endblock %}