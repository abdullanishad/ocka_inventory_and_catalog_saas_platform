{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto p-4 sm:p-6">

  <h1 class="sr-only">Your Cart</h1>

  {% if items %}

    <!-- Wrap items so JS can clear them after successful booking -->
    <div id="cart-items-wrapper">
      {% for item in items %}
        <!-- Cart item card -->
        <div class="bg-white border rounded-2xl p-3 sm:p-4 mb-4 cart-item-card" data-key="{{ item.key }}">
          <div class="grid grid-cols-[72px,1fr,auto] gap-3 sm:gap-4 items-start">
            <!-- Thumb -->
            <div class="h-[72px] w-[72px] rounded-lg overflow-hidden bg-gray-100">
              {% if item.image %}
                <img src="{{ item.image }}" alt="" class="w-full h-full object-cover">
              {% else %}
                <div class="w-full h-full grid place-items-center text-xs text-gray-400">No image</div>
              {% endif %}
            </div>

            <!-- Info -->
            <div class="min-w-0">
              <div class="flex items-baseline justify-between sm:justify-start sm:gap-3">
                <h2 class="text-gray-900 font-semibold truncate">{{ item.name }}</h2>
                <div class="sm:hidden text-gray-900 font-semibold">₹{{ item.price }}/unit</div>
              </div>
              {% if item.sku %}
                <div class="text-xs text-gray-500 mt-0.5">SKU: {{ item.sku|default:"(no sku)" }}</div>
              {% endif %}
              {% if item.moq %}
                <div class="text-xs text-gray-500 mt-0.5">MOQ: {{ item.moq }}</div>
              {% endif %}
              <div class="text-xs text-gray-500 mt-0.5">Qty: {{ item.quantity }}</div>
            </div>

            <!-- Unit price (desktop) -->
            <div class="hidden sm:block text-right">
              <div class="text-gray-900 font-semibold">Unit price : ₹{{ item.price }}</div>
            </div>
          </div>

          <!-- Qty + Subtotal + Remove -->
          <div class="mt-3 sm:mt-4 flex items-center justify-between">
            <div class="flex items-center gap-2 sm:gap-3">
              <div class="text-lg sm:text-xl font-semibold text-gray-900">₹{{ item.subtotal }}</div>

              <!-- Remove -->
              <a href="{% url 'orders:remove_from_cart' item.key %}"
                class="grid place-items-center h-10 w-10 rounded-xl bg-red-600 text-white hover:bg-red-700"
                aria-label="Remove item">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
              </a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Order Summary -->
    <div id="order-summary" class="bg-white border rounded-2xl p-4 sm:p-5">
      <h3 class="text-lg font-semibold text-gray-900">Order Summary</h3>
      <div class="mt-3 flex items-center justify-between">
        <span class="text-gray-600">Total :</span>
        <span id="cart-total" class="text-xl font-semibold text-gray-900">₹{{ total }}</span>
      </div>

      <!-- Book Order button — now sends AJAX POST and shows modal -->
      <button id="book-order-btn"
              data-url="{% url 'orders:ajax_checkout' %}"
              class="mt-4 block w-full h-12 rounded-xl bg-black text-white font-semibold grid place-items-center hover:bg-gray-900">
        Book Order
      </button>
      <p class="text-xs text-gray-500 mt-2">* Shipping &amp; GST applies</p>
    </div>

  {% else %}
    <div id="empty-cart-message" class="bg-white border rounded-2xl p-6 text-center text-gray-600">
      Your cart is empty.
    </div>
  {% endif %}
</div>

<!-- Multi-order Success Modal -->
<div id="order-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
  <div class="bg-white rounded-2xl p-6 w-full max-w-lg mx-4 text-left">
    <div class="flex items-center gap-4 mb-4">
      <div class="flex items-center justify-center p-3 rounded-full bg-green-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <div>
        <h2 class="text-xl font-semibold">Order(s) placed</h2>
        <p class="text-sm text-gray-600">Your orders have been created successfully.</p>
      </div>
    </div>

    <div id="order-list-container" class="space-y-3 mb-4">
      <!-- JS will inject a list of created orders here -->
      <!-- Example injected item:
        <div class="flex justify-between items-center">
          <div>Order <span class="font-mono">ORD-XXXX</span></div>
          <a href="/orders/1/" class="text-sm text-blue-600">View</a>
        </div>
      -->
    </div>

    <div class="flex justify-end gap-3">
      <button id="modal-close" class="px-4 py-2 rounded-lg border font-medium">Close</button>
      <a id="modal-view-all" href="{% url 'orders:list' %}" class="px-4 py-2 rounded-lg bg-black text-white font-medium">View all orders</a>
    </div>
  </div>
</div>


<!-- Auto-submit qty change + live total update (optimistic) -->
<script>
(function(){
  const forms = Array.from(document.querySelectorAll('form[action$="update/"]'));
  const totalEl = document.getElementById('cart-total');

  // Debounce helper
  const debounce = (fn, d=400) => {
    let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), d); };
  };

  forms.forEach(form => {
    const input = form.querySelector('.qty-input');
    if (!input) return;

    // Optimistic subtotal + total update
    const row = form.closest('.bg-white.border.rounded-2xl');
    const priceEl = row.querySelector('.text-gray-900.font-semibold'); // unit price (desktop or mobile)
    const altPriceEl = row.querySelector('.grid .text-gray-900.font-semibold'); // mobile top-right (fallback)
    const unitPrice = (() => {
      const el = priceEl || altPriceEl;
      if (!el) return 0;
      const m = el.textContent.replace(/[^0-9.]/g,'');
      return Number(m || '0');
    })();
    const subtotalEl = row.querySelector('.text-lg, .text-xl');

    const post = debounce(() => {
      const formData = new FormData(form);
      fetch(form.action, {
        method: 'POST',
        headers: {'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || ''},
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data && data.total_amount && totalEl) {
          totalEl.textContent = '₹' + String(data.total_amount);
        }
      })
      .catch(()=>{ /* silent */ });
    }, 400);

    const recalcLocal = () => {
      const qty = Math.max(0, parseInt(input.value || '0', 10));
      if (subtotalEl) {
        subtotalEl.textContent = '₹' + (unitPrice * qty).toLocaleString('en-IN');
      }
    };

    input.addEventListener('input', () => { recalcLocal(); post(); });
    input.addEventListener('change', () => { recalcLocal(); post(); });
  });
})();
</script>

<!-- Book Order AJAX + modal handling -->
<script>
(function () {
  const btn = document.getElementById('book-order-btn');
  const modal = document.getElementById('order-modal');
  const modalClose = document.getElementById('modal-close');
  const orderListContainer = document.getElementById('order-list-container');
  const modalViewAll = document.getElementById('modal-view-all');
  const wholesalerList = document.getElementById('wholesaler-orders-list'); // optional on page
  const cartItemsWrapper = document.getElementById('cart-items-wrapper');
  const orderSummary = document.getElementById('order-summary');
  const cartTotal = document.getElementById('cart-total');
  const emptyCartMsg = document.getElementById('empty-cart-message');

  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie('csrftoken') || document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;

  function openModal() {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
  function closeModal() {
    modal.classList.remove('flex');
    modal.classList.add('hidden');
  }

  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
  if (modalClose) modalClose.addEventListener('click', closeModal);

  if (!btn) return;

  btn.addEventListener('click', async function (e) {
    e.preventDefault();
    const url = btn.dataset.url;
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ action: 'create_from_cart' }),
        credentials: 'same-origin'
      });

      // Debugging helper when something goes wrong:
      if (!res.ok) {
        const txt = await res.text();
        console.error('checkout failed', res.status, txt);
        alert(`Failed to place order (status ${res.status}). Check console.`);
        return;
      }

      const data = await res.json();
      if (!data || !data.success) {
        alert(data?.error || 'Could not create order.');
        return;
      }

      const orders = data.orders || [];
      // clear previous injected list
      if (orderListContainer) orderListContainer.innerHTML = '';

      orders.forEach(o => {
        // inject into modal list
        const row = document.createElement('div');
        row.className = 'flex justify-between items-center';
        row.innerHTML = `<div>Order <span class="font-mono">${o.order_number}</span> <span class="text-xs text-gray-500">₹${o.order_total}</span></div>
                         <a href="${o.order_url}" class="text-sm text-blue-600">View</a>`;
        orderListContainer.appendChild(row);

        // insert into wholesaler orders list on the page (if provided)
        if (o.html && wholesalerList) {
          const wrapper = document.createElement('div');
          wrapper.innerHTML = o.html;
          const node = wrapper.firstElementChild;
          if (node) wholesalerList.prepend(node);
        }
      });

      // UI: clear cart items and update summary
      if (cartItemsWrapper) cartItemsWrapper.innerHTML = '';
      if (cartTotal) cartTotal.textContent = '₹0';
      if (orderSummary) {
        const bookBtn = document.getElementById('book-order-btn');
        if (bookBtn) bookBtn.remove();
      }
      if (emptyCartMsg) {
        emptyCartMsg.style.display = 'block';
      } else {
        const container = document.querySelector('.max-w-3xl.mx-auto');
        if (container) {
          const div = document.createElement('div');
          div.id = 'empty-cart-message';
          div.className = 'bg-white border rounded-2xl p-6 text-center text-gray-600';
          div.textContent = 'Your cart is empty.';
          container.appendChild(div);
        }
      }

      // show modal with created orders
      openModal();

    } catch (err) {
      console.error('Fetch error:', err);
      alert('Unexpected error while creating order. See console.');
    }
  });
})();
</script>

{% endblock %}
