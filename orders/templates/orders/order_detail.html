{% extends "base.html" %}

{% block content %}
<div class="max-w-5xl mx-auto p-4 sm:p-6">

  <div class="flex items-start justify-between gap-6 mb-6">
    <div>
      <h1 class="text-2xl sm:text-3xl font-bold mb-1">Order <span class="font-mono">{{ order.number }}</span></h1>

      {% if placed_at %}
        <p class="text-sm text-gray-500">Placed on {{ placed_at|date:"M d, Y" }}</p>
      {% else %}
        <p class="text-sm text-gray-500">Placed on —</p>
      {% endif %}

      <div class="mt-3 inline-flex items-center gap-2">
        {% if order.status == order.Status.PENDING %}
          <span class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 text-sm font-medium">Pending</span>
        {% elif order.status == order.Status.CONFIRMED %}
          <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-sm font-medium">Confirmed</span>
        {% elif order.status == order.Status.SHIPPED %}
          <span class="px-3 py-1 rounded-full bg-indigo-100 text-indigo-800 text-sm font-medium">Shipped</span>
        {% elif order.status == order.Status.DELIVERED %}
          <span class="px-3 py-1 rounded-full bg-green-100 text-green-800 text-sm font-medium">Delivered</span>
        {% else %}
          <span class="px-3 py-1 rounded-full bg-gray-100 text-gray-800 text-sm font-medium">{{ order.get_status_display }}</span>
        {% endif %}
      </div>
    </div>

    <div class="flex items-center gap-3">
      {% if is_staff %}
        <a href="{% url 'orders:edit' order.pk %}" class="px-4 py-2 border rounded bg-white text-sm">Edit</a>
      {% endif %}

      {% if is_wholesaler %}
        {% if order.status == 'PENDING' %}
          <form method="post" action="{% url 'orders:update_status' order.pk %}">
              {% csrf_token %}
              <input type="hidden" name="status" value="AWAITING_PAYMENT">
              <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white text-sm">Confirm Order</button>
          </form>
          <form method="post" action="{% url 'orders:update_status' order.pk %}">
              {% csrf_token %}
              <input type="hidden" name="status" value="REJECTED">
              <button type="submit" class="px-4 py-2 rounded bg-red-600 text-white text-sm">Reject Order</button>
          </form>
        {% elif order.status == 'PAID' %}
          <a href="#" class="px-4 py-2 rounded bg-green-600 text-white text-sm">Upload Shipping Info</a>
        {% endif %}
      {% endif %}

      {% if is_retailer %}
        {% if order.status == 'AWAITING_PAYMENT' %}
            <button id="pay-button" class="w-full px-4 py-3 rounded-lg bg-green-600 text-white font-bold">Pay Now (₹{{ order.total_value }})</button>
            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        {% elif order.status == 'REJECTED' %}
            <p class="text-red-600 font-semibold">This order was rejected by the wholesaler.</p>
        {% endif %}
    {% endif %}

    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 bg-white border rounded-2xl p-4">
      <h2 class="font-semibold mb-3">Items ({{ order.items_count }})</h2>

      <div class="divide-y">
        {% for item in order_items %}
          <div class="py-3 flex items-start gap-4">
            <div class="w-20 h-20 bg-gray-100 rounded overflow-hidden">
              {% if item.product and item.product.image %}
                <img src="{{ item.product.image.url }}" alt="" class="w-full h-full object-cover">
              {% endif %}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-baseline justify-between">
                <div class="truncate">
                  <div class="font-medium text-gray-900">
                    {% if item.product %}{{ item.product.name }}{% else %}Item{% endif %}
                  </div>
                  {% if item.product and item.product.sku %}
                    <div class="text-xs text-gray-500">SKU: {{ item.product.sku }}</div>
                  {% endif %}
                </div>
                <div class="text-right ml-4">
                  <div class="font-semibold">₹{{ item.price|floatformat:2 }}</div>
                  <div class="text-xs text-gray-500">Unit price</div>
                </div>
              </div>

              <div class="mt-2 flex items-center justify-between text-sm text-gray-600">
                <div>Qty: <span class="font-medium">{{ item.quantity }}</span></div>
                <div>Subtotal: <span class="font-medium">₹{{ item.subtotal|floatformat:2 }}</span></div>
              </div>
            </div>
          </div>
        {% empty %}
          <p class="text-gray-500">No items on this order.</p>
        {% endfor %}
      </div>

      <div class="mt-6 border-t pt-4">
        <h3 class="font-semibold mb-2">Order notes</h3>
        {% if order.notes %}
          <p class="text-sm text-gray-700">{{ order.notes }}</p>
        {% else %}
          <p class="text-sm text-gray-500">No notes.</p>
        {% endif %}
      </div>
    </div>

    <aside class="bg-white border rounded-2xl p-4">
      <h3 class="font-semibold mb-3">Summary</h3>

      <div class="space-y-3 text-sm text-gray-700">
        <div class="flex justify-between">
          <span>Items</span>
          <span>{{ order.items_count }}</span>
        </div>

        <div class="flex justify-between">
          <span>Subtotal</span>
          <span>₹{{ order.total_value|floatformat:2 }}</span>
        </div>

        {% if order.shipping_value %}
          <div class="flex justify-between">
            <span>Shipping</span>
            <span>₹{{ order.shipping_value|floatformat:2 }}</span>
          </div>
        {% endif %}

        <div class="flex justify-between font-semibold">
          <span>Total</span>
          <span>₹{{ order.total_value|floatformat:2 }}</span>
        </div>

        <div class="pt-2 border-t mt-2">
          <div class="text-xs text-gray-500">Payment</div>
          <div class="font-medium">{{ order.get_payment_method_display }} • {{ order.payment_status }}</div>
        </div>

        <div class="pt-2 border-t mt-2">
          <div class="text-xs text-gray-500">Retailer</div>
          <div class="font-medium">{{ order.retailer.name }}</div>
          {% if order.retailer.city %}<div class="text-xs text-gray-500">{{ order.retailer.city }}</div>{% endif %}
        </div>

        <div class="pt-2 border-t mt-2">
          <div class="text-xs text-gray-500">Wholesaler</div>
          {% if order.wholesaler %}
            <div class="font-medium">{{ order.wholesaler.name }}</div>
            {% if order.wholesaler.city %}<div class="text-xs text-gray-500">{{ order.wholesaler.city }}</div>{% endif %}
          {% else %}
            <div class="font-medium">—</div>
          {% endif %}
        </div>
      </div>
    </aside>
  </div>

</div>

<script>
(function(){
  function getCookie(name){ const v = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v ? v.pop() : ''; }
  const csrftoken = getCookie('csrftoken');

  // generic handler for any button with data-status
  document.querySelectorAll('button[data-status]').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const status = btn.dataset.status;
      const url = btn.dataset.url;
      if (!url) return;
      btn.disabled = true;
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ status })
        });
        if (!res.ok) {
          const txt = await res.text();
          console.error('status update failed', res.status, txt);
          alert('Failed to update status. See console.');
          btn.disabled = false;
          return;
        }
        const data = await res.json();
        if (data.success) {
          location.reload();
        } else {
          alert(data.error || 'Update failed');
          btn.disabled = false;
        }
      } catch(err){
        console.error(err);
        alert('Unexpected error; see console.');
        btn.disabled = false;
      }
    });
  });
})();
</script>

{% endblock %}