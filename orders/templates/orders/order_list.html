{% extends "base.html" %}
{% load static %}
{% load order_ui %}

{% block title %}Orders{% endblock %}

{% block content %}

<div class="min-h-screen bg-gray-50">
    {% include "partials/nav_tabs.html" %}

  <!-- Page header -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-semibold tracking-tight">Orders</h1>

    <div class="flex items-center gap-2">
      <!-- Date preset dropdown -->
      <form id="filters" method="get" class="flex items-center gap-2">
        <div class="relative">
          <select name="date" class="appearance-none pl-3 pr-8 py-2 rounded-md border border-gray-300 text-sm"
                  onchange="document.getElementById('filters').submit()">
            {% with p=request.GET.date|default:'this_week' %}
              <option value="this_week" {% if p == 'this_week' %}selected{% endif %}>Date: This Week</option>
              <option value="last_week" {% if p == 'last_week' %}selected{% endif %}>Last Week</option>
              <option value="this_month" {% if p == 'this_month' %}selected{% endif %}>This Month</option>
              <option value="last_30" {% if p == 'last_30' %}selected{% endif %}>Last 30 Days</option>
              <option value="all" {% if p == 'all' %}selected{% endif %}>All Time</option>
            {% endwith %}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center">
            <!-- chevron -->
            <svg class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"/></svg>
          </div>
        </div>

        <!-- Preserve other params when exporting -->
        <a href="{% url 'orders:export' %}?{{ request.GET.urlencode }}"
           class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-300 text-sm hover:bg-gray-50">
          <!-- download icon -->
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"/>
          </svg>
          Export
        </a>
      </form>
    </div>
  </div>

  <!-- Tabs -->
  {% load order_ui %}

<!-- Tabs -->
<div class="flex flex-wrap gap-2 mb-4">
  {% for k,l in tabs %}
  <a href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.date %}date={{ request.GET.date }}&{% endif %}status={{ k }}"
     class="px-3 py-2 rounded-md text-sm border transition
            {% if active_status == k %}
              bg-gray-900 text-white border-gray-900
            {% else %}
              bg-white text-gray-700 border-gray-300 hover:bg-gray-50
            {% endif %}">
      {{ l }}: {{ counts|dict_get:k }}

  </a>
{% endfor %}

</div>


  <!-- Search -->
  <form method="get" class="mb-4">
    {% if request.GET.status %}<input type="hidden" name="status" value="{{ request.GET.status }}">{% endif %}
    {% if request.GET.date %}<input type="hidden" name="date" value="{{ request.GET.date }}">{% endif %}
    <div class="relative max-w-md">
      <input type="text" name="q" value="{{ request.GET.q }}"
             class="w-full pl-10 pr-3 py-2 rounded-md border border-gray-300"
             placeholder="Search orders...">
      <div class="pointer-events-none absolute inset-y-0 left-3 flex items-center">
        <svg class="w-4 h-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/>
        </svg>
      </div>
    </div>
  </form>

  <!-- Table -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 text-gray-600 text-xs uppercase">
          <tr>
            <th class="text-left px-6 py-3">Order & Date</th>
            <th class="text-left px-6 py-3">Retailer & Location</th>
            <th class="text-left px-6 py-3">Items & Value</th>
            <th class="text-left px-6 py-3">Payment Status</th>
            <th class="text-left px-6 py-3">Status</th>
            <th class="text-left px-6 py-3">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for o in orders %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4">
                <div class="font-medium">#{{ o.number }}</div>
                <div class="text-gray-500 text-xs">{{ o.date|date:"M j" }}</div>
              </td>
              <td class="px-6 py-4">
                <div class="font-medium">{{ o.retailer.name }}</div>
                <div class="text-gray-500 text-xs">
                  {% if o.retailer.city %}{{ o.retailer.city }}{% endif %}
                  {% if o.retailer.state %} ({{ o.retailer.state }}){% endif %}
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="font-medium">{{ o.items_count }} items</div>
                <div class="text-gray-500 text-xs">₹{{ o.total_value|floatformat:0 }}</div>
              </td>
              <td class="px-6 py-4">
                <div class="font-medium">
                  {{ o.get_payment_method_display }}
                </div>
                <div class="text-gray-500 text-xs">{{ o.payment_status }}</div>
              </td>
              <td class="px-6 py-4">{% status_badge o.status %}</td>  <!-- ✅ correct -->

              <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                  <a href="{% url 'orders:list' %}?q={{ o.number }}" class="p-2 rounded-md border border-gray-300 hover:bg-gray-100" title="View">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M1.5 12s4.5-7.5 10.5-7.5S22.5 12 22.5 12 18 19.5 12 19.5 1.5 12 1.5 12z"/>
                      <circle cx="12" cy="12" r="3" stroke-width="2"></circle>
                    </svg>
                  </a>
                  <button class="p-2 rounded-md border border-gray-300 hover:bg-gray-100" title="Print"
                          onclick="window.print()">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 9V4h12v5M6 18H5a2 2 0 01-2-2v-3a2 2 0 012-2h14a2 2 0 012 2v3a2 2 0 01-2 2h-1M6 14h12v6H6z"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="px-6 py-10 text-center text-gray-500">No orders found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
      <div class="flex items-center justify-between p-4 border-t border-gray-100">
        <div class="text-xs text-gray-500">
          Showing {{ page_obj.start_index }}–{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
        </div>
        <div class="flex gap-2">
          {% if page_obj.has_previous %}
            <a class="px-3 py-1 border rounded-md text-sm" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">Prev</a>
          {% endif %}
          {% if page_obj.has_next %}
            <a class="px-3 py-1 border rounded-md text-sm" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">Next</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
