{% extends "base.html" %}
{% load static %}
{% load order_ui %}

{% block title %}Orders{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pb-20"> {# padding-bottom for nav bar #}

  <main class="max-w-7xl mx-auto px-6 py-8">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-semibold tracking-tight">Orders </h1>
    &nbsp;  

    <div class="flex items-center gap-2">
      <form id="filters" method="get" class="flex items-center gap-2">
        <div class="relative">
          <select name="date" class="appearance-none pl-3 pr-8 py-2 rounded-md border border-gray-300 text-sm"
                  onchange="document.getElementById('filters').submit()">
            {% with p=request.GET.date|default:'this_week' %}
              <option value="this_week" {% if p == 'this_week' %}selected{% endif %}>Date: This Week</option>
              <option value="last_week" {% if p == 'last_week' %}selected{% endif %}>Last Week</option>
              <option value="this_month" {% if p == 'this_month' %}selected{% endif %}>This Month</option>
              <option value="last_30" {% if p == 'last_30' %}selected{% endif %}>Last 30 Days</option>
              <option value="all" {% if p == 'all' %}selected{% endif %}>All Time</option>
            {% endwith %}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center">
            <svg class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"/></svg>
          </div>
        </div>

        <a href="{% url 'orders:export' %}?{{ request.GET.urlencode }}"
           class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-300 text-sm hover:bg-gray-50">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"/>
          </svg>
          Export
        </a>
      </form>
    </div>
  </div>

  {# --- UPDATED TABS SECTION --- #}
  <style>
    .status-tab .count-badge {
      background-color: #e5e7eb;
      color: #4b5563;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      margin-left: 0.5rem;
      line-height: 1;
    }
    .status-tab.active .count-badge {
      background-color: rgba(255, 255, 255, 0.25);
      color: #ffffff;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>

  <div class="mb-4">
    <div class="flex gap-2 pb-2 -mb-2 overflow-x-auto no-scrollbar">
      {% for k,l in tabs %}
        {% with count=counts|dict_get:k %}
          <a href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.date %}date={{ request.GET.date }}&{% endif %}status={{ k }}"
             class="status-tab flex-shrink-0 px-3 py-2 rounded-lg text-sm border transition-colors flex items-center
                    {% if active_status == k %}
                      bg-gray-900 text-white border-gray-900 active
                    {% else %}
                      bg-white text-gray-700 border-gray-300 hover:bg-gray-50
                    {% endif %}">
              {{ l }} <span class="count-badge">{{ count }}</span>
          </a>
        {% endwith %}
      {% endfor %}
    </div>
  </div>
  {# --- END OF UPDATED TABS SECTION --- #}

  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
    <div class="divide-y">

      <div class="grid grid-cols-4 gap-4 items-center bg-gray-50 text-xs font-medium text-gray-500 px-4 py-2">
        <div>Order</div>
        <div>
          {% if is_wholesaler %}Retailer{% else %}Wholesaler{% endif %}
        </div>
        <div>Order Status</div>
        <div class="text-right">Items / Value</div>
      </div>

      {% if orders %}
        <ul class="divide-y">
          {% for o in orders %}
            <li class="flex items-center justify-between hover:bg-gray-50">
              <a href="{% url 'orders:detail' o.pk %}"
                 class="flex-1 block p-4 text-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-300">
                <div class="grid grid-cols-4 gap-4 items-center">
                  <div>
                    <div class="font-medium text-gray-900">#{{ o.number }}</div>
                    <div class="text-gray-500 text-xs">{{ o.date|date:"M j, P" }}</div>
                  </div>

                  <div>
                    {% if is_wholesaler %}
                      <div class="font-medium text-gray-900">{{ o.retailer.name }}</div>
                      {% with profile=o.retailer.users.first.profile %}
                        {% if profile and profile.city %}
                          <div class="text-gray-500 text-xs">{{ profile.city }}</div>
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      <div class="font-medium text-gray-900">{{ o.wholesaler.name }}</div>
                      {% with profile=o.wholesaler.users.first.profile %}
                        {% if profile and profile.city %}
                          <div class="text-gray-500 text-xs">{{ profile.city }}</div>
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  </div>

                  <div>
                      <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full
                                   {% if o.status == o.Status.PENDING %}bg-yellow-100 text-yellow-800
                                   {% elif o.status == o.Status.AWAITING_PAYMENT %}bg-blue-100 text-blue-800
                                   {% elif o.status == o.Status.PAID %}bg-green-100 text-green-800
                                   {% elif o.status == o.Status.SHIPPED %}bg-indigo-100 text-indigo-800
                                   {% elif o.status == o.Status.REJECTED or o.status == o.Status.CANCELLED %}bg-red-100 text-red-800
                                   {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ o.get_status_display }}
                      </span>
                  </div>

                  <div class="text-right">
                    <div class="font-medium">{{ o.annot_items_count }} items</div>
                    <div class="text-gray-500 text-xs">₹{{ o.grand_total|floatformat:0 }}</div>
                  </div>
                </div>
              </a>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="p-6 text-center text-gray-500">No orders found.</div>
      {% endif %}
    </div>

    {% if is_paginated %}
      <div class="flex items-center justify-between p-4 border-t border-gray-100">
        <div class="text-xs text-gray-500">
          Showing {{ page_obj.start_index }}–{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
        </div>
        <div class="flex gap-2">
          {% if page_obj.has_previous %}
            <a class="px-3 py-1 border rounded-md text-sm" href="?page={{ page_obj.previous_page_number }}&{{ pagination_params }}">Prev</a>
          {% endif %}
          {% if page_obj.has_next %}
            <a class="px-3 py-1 border rounded-md text-sm" href="?page={{ page_obj.next_page_number }}&{{ pagination_params }}">Next</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</main>
</div>
{% endblock %}