{% extends "base.html" %}
{% load static %}
{% load order_ui %}

{% block title %}Orders{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pb-20"> {# padding-bottom for nav bar #}

  <!-- Page Content -->
  <main class="max-w-7xl mx-auto px-6 py-8">
  <!-- Page header -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-semibold tracking-tight">Orders</h1>

    <div class="flex items-center gap-2">
      <!-- Date preset dropdown -->
      <form id="filters" method="get" class="flex items-center gap-2">
        <div class="relative">
          <select name="date" class="appearance-none pl-3 pr-8 py-2 rounded-md border border-gray-300 text-sm"
                  onchange="document.getElementById('filters').submit()">
            {% with p=request.GET.date|default:'this_week' %}
              <option value="this_week" {% if p == 'this_week' %}selected{% endif %}>Date: This Week</option>
              <option value="last_week" {% if p == 'last_week' %}selected{% endif %}>Last Week</option>
              <option value="this_month" {% if p == 'this_month' %}selected{% endif %}>This Month</option>
              <option value="last_30" {% if p == 'last_30' %}selected{% endif %}>Last 30 Days</option>
              <option value="all" {% if p == 'all' %}selected{% endif %}>All Time</option>
            {% endwith %}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center">
            <!-- chevron -->
            <svg class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"/></svg>
          </div>
        </div>

        <!-- Preserve other params when exporting -->
        <a href="{% url 'orders:export' %}?{{ request.GET.urlencode }}"
           class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-300 text-sm hover:bg-gray-50">
          <!-- download icon -->
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"/>
          </svg>
          Export
        </a>
      </form>
    </div>
  </div>

  <!-- Tabs -->
  {% load order_ui %}

<!-- Tabs -->
<div class="flex flex-wrap gap-2 mb-4">
  {% for k,l in tabs %}
  <a href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}&{% endif %}{% if request.GET.date %}date={{ request.GET.date }}&{% endif %}status={{ k }}"
     class="px-3 py-2 rounded-md text-sm border transition
            {% if active_status == k %}
              bg-gray-900 text-white border-gray-900
            {% else %}
              bg-white text-gray-700 border-gray-300 hover:bg-gray-50
            {% endif %}">
      {{ l }}: {{ counts|dict_get:k }}

  </a>
{% endfor %}

</div>


  <!-- Search -->
  <!-- <form method="get" class="mb-4">
    {% if request.GET.status %}<input type="hidden" name="status" value="{{ request.GET.status }}">{% endif %}
    {% if request.GET.date %}<input type="hidden" name="date" value="{{ request.GET.date }}">{% endif %}
    <div class="relative max-w-md">
      <input type="text" name="q" value="{{ request.GET.q }}"
             class="w-full pl-10 pr-3 py-2 rounded-md border border-gray-300"
             placeholder="Search orders...">
      <div class="pointer-events-none absolute inset-y-0 left-3 flex items-center">
        <svg class="w-4 h-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/>
        </svg>
      </div>
    </div>
  </form> -->

<!-- Order List -->
<div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
  <div class="divide-y">

    <!-- table header -->
    <div class="grid grid-cols-4 gap-4 items-center bg-gray-50 text-xs font-medium text-gray-500 px-4 py-2">
      <div>Order</div>
      <div>
        {% comment %} Show opposite party name: if this user is a wholesaler, show Retailer; else show Wholesaler {% endcomment %}
        {% if is_wholesaler %}Retailer{% else %}Wholesaler{% endif %}
      </div>
      <div>Order Status</div>
      <div class="text-right">Items / Value</div>
    </div>

    {% if orders %}
      <ul class="divide-y">
        {% for o in orders %}
          <li class="flex items-center justify-between hover:bg-gray-50">
            <!-- main clickable area -->
            <a href="{% url 'orders:detail' o.pk %}"
               class="flex-1 block p-4 text-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-300">
              <div class="grid grid-cols-4 gap-4 items-center">
                <!-- Order col -->
                <div>
                  <div class="font-medium text-gray-900">#{{ o.number }}</div>
                  <div class="text-gray-500 text-xs">{{ o.date|date:"M j" }}</div>
                </div>

                <!-- Opposite party (Retailer or Wholesaler) -->
                <div>
                  {% if is_wholesaler %}
                    <div class="font-medium text-gray-900">{{ o.retailer.name }}</div>
                    <div class="text-gray-500 text-xs">
                      {% if o.retailer.city %}{{ o.retailer.city }}{% endif %}
                      {% if o.retailer.state %} ({{ o.retailer.state }}){% endif %}
                    </div>
                  {% else %}
                    {# show wholesaler info; assumes order has o.wholesaler relation #}
                    <div class="font-medium text-gray-900">{{ o.wholesaler.name }}</div>
                    <div class="text-gray-500 text-xs">
                      {% if o.wholesaler.city %}{{ o.wholesaler.city }}{% endif %}
                      {% if o.wholesaler.state %} ({{ o.wholesaler.state }}){% endif %}
                    </div>
                  {% endif %}
                </div>

                <!-- Status column -->
                <div>
                  {# status badge: o.status expected values: Pending, Confirmed, Shipped, Delivered, Cancelled #}
                  {% with s=o.status %}
                    <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full
                                 {% if s == 'Pending' %}bg-yellow-100 text-yellow-800
                                 {% elif s == 'Confirmed' %}bg-blue-100 text-blue-800
                                 {% elif s == 'Shipped' %}bg-indigo-100 text-indigo-800
                                 {% elif s == 'Delivered' %}bg-green-100 text-green-800
                                 {% elif s == 'Cancelled' %}bg-red-100 text-red-800
                                 {% else %}bg-gray-100 text-gray-800{% endif %}">
                      {{ s }}
                    </span>
                    {% if o.status_note %}
                      <div class="text-gray-400 text-xs mt-1">{{ o.status_note }}</div>
                    {% endif %}
                  {% endwith %}
                </div>

                <!-- Items & value -->
                <!-- Items & value -->
              <div class="text-right">
                <div class="font-medium">
                  {% with count=o.annot_items_count|default:o.items_count %}
                    {{ count }} items
                  {% endwith %}
                </div>
                <div class="text-gray-500 text-xs">
                  {% with val=o.annot_total_value|default:o.total_value %}
                    ₹{{ val|floatformat:0 }}
                  {% endwith %}
                </div>
              </div>

              </div>
            </a>

            
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="p-6 text-center text-gray-500">No orders found.</div>
    {% endif %}
  </div>

  <!-- Pagination -->
  {% if is_paginated %}
    <div class="flex items-center justify-between p-4 border-t border-gray-100">
      <div class="text-xs text-gray-500">
        Showing {{ page_obj.start_index }}–{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
      </div>
      <div class="flex gap-2">
        {% if page_obj.has_previous %}
          <a class="px-3 py-1 border rounded-md text-sm" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">Prev</a>
        {% endif %}
        {% if page_obj.has_next %}
          <a class="px-3 py-1 border rounded-md text-sm" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">Next</a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>


  <!-- Pagination -->
  {% if is_paginated %}
    <div class="flex items-center justify-between p-4 border-t border-gray-100">
      <div class="text-xs text-gray-500">
        Showing {{ page_obj.start_index }}–{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
      </div>
      <div class="flex gap-2">
        {% if page_obj.has_previous %}
          <a class="px-3 py-1 border rounded-md text-sm" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">Prev</a>
        {% endif %}
        {% if page_obj.has_next %}
          <a class="px-3 py-1 border rounded-md text-sm" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">Next</a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

</div>
</main>
{% endblock %}
